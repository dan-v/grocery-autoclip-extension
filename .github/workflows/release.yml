name: Create Release

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0, v2.1.3, etc.

permissions:
  contents: write
  packages: read

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Extract version from tag
      id: version
      run: |
        TAG_VERSION=${GITHUB_REF#refs/tags/v}
        echo "tag_version=$TAG_VERSION" >> $GITHUB_OUTPUT
        
        # Extract version from manifest
        MANIFEST_VERSION=$(grep '"version"' manifest.json | sed 's/.*"version": "\([^"]*\)".*/\1/')
        echo "manifest_version=$MANIFEST_VERSION" >> $GITHUB_OUTPUT
        
        echo "Tag version: $TAG_VERSION"
        echo "Manifest version: $MANIFEST_VERSION"
        
    - name: Verify version consistency
      run: |
        if [ "${{ steps.version.outputs.tag_version }}" != "${{ steps.version.outputs.manifest_version }}" ]; then
          echo "❌ Version mismatch!"
          echo "Tag version: ${{ steps.version.outputs.tag_version }}"
          echo "Manifest version: ${{ steps.version.outputs.manifest_version }}"
          echo "Please ensure the tag version matches the version in manifest.json"
          exit 1
        fi
        echo "✅ Version consistency verified"
        
    - name: Set up Node.js
      uses: actions/setup-node@v5
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build TypeScript
      run: npm run build

    - name: Set up build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y zip unzip
        
    - name: Build webstore package
      run: |
        chmod +x scripts/build-webstore.sh
        scripts/build-webstore.sh
        
    - name: Generate changelog
      id: changelog
      run: |
        # Simple release notes
        cat > RELEASE_NOTES.md << EOF
        Chrome extension for automatically clipping Safeway digital coupons.
        
        Download the zip file and load it as an unpacked extension in Chrome.
        EOF
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          builds/grocery-autoclip-v${{ steps.version.outputs.tag_version }}-webstore.zip
        body_path: RELEASE_NOTES.md
        name: "v${{ steps.version.outputs.tag_version }}"
        draft: false
        prerelease: false
        generate_release_notes: false  # We're providing our own notes
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Post-release validation
      run: |
        echo "🎉 Release v${{ steps.version.outputs.tag_version }} created successfully!"
        echo ""
        echo "📋 Next steps:"
        echo "1. Download the release package from: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.tag_version }}"
        echo "2. Test the extension locally by loading it unpacked in Chrome"
        echo "3. Upload to Chrome Web Store Developer Dashboard"
        echo "4. Update store listing if needed"
        echo "5. Submit for review"
        echo ""
        echo "📊 Release summary:"
        echo "- Version: ${{ steps.version.outputs.tag_version }}"
        echo "- Package: grocery-autoclip-v${{ steps.version.outputs.tag_version }}-webstore.zip"
        echo "- Release URL: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.tag_version }}"